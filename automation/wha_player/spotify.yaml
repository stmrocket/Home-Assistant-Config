#All operations expect Nuvo source 1...

- alias: Spotify Update Keypad Dispinfo when Playing
  trigger:
    - platform: template
      value_template: "{{ state_attr('media_player.spotify_home', 'media_duration') }}"
    - platform: template
      value_template: "{{ state_attr('media_player.spotify_home', 'media_position') }}"
    - platform: state
      entity_id: media_player.spotify_home
  condition:
    - condition: state
      entity_id: media_player.spotify_home
      state: playing
  action:
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/info
        payload_template: "1,{{ (state_attr('media_player.spotify_home', 'media_duration') | float * 10) | float |  round(0)}},{{ (state_attr('media_player.spotify_home', 'media_position') | float * 10) | float |  round(0)}},{% if is_state('media_player.spotify_home', 'playing')  -%}2{%- elif is_state('media_player.spotify_home', 'paused') -%}3{%- else -%}1{%- endif %}"

- alias: Spotify Update Keypad Dispinfo when pausing
  trigger:
    - platform: state
      entity_id: media_player.spotify_home
      to: paused
  action:
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/info
        payload_template: "1,{{ (state_attr('media_player.spotify_home', 'media_duration') | float * 10) | float |  round(0)}},{{ (state_attr('media_player.spotify_home', 'media_position') | float * 10) | float |  round(0)}},{% if is_state('media_player.spotify_home', 'playing')  -%}2{%- elif is_state('media_player.spotify_home', 'paused') -%}3{%- else -%}1{%- endif %}"

- alias: Spotify Update Keypad Displine
  trigger:
    - platform: template
      value_template: "{{ state_attr('media_player.spotify_home', 'media_duration') }}"
    - platform: template
      value_template: "{{ state_attr('media_player.spotify_home', 'media_position') }}"
    - platform: state
      entity_id: media_player.spotify_home
  condition:
    - condition: state
      entity_id: media_player.spotify_home
      state: playing
    - condition: template
      value_template: "{{ not state_attr('media_player.spotify_home', 'media_title') ==  None }}"
    - condition: template
      value_template: "{{ not state_attr('media_player.spotify_home', 'media_artist') ==  None }}"
    - condition: template
      value_template: "{{ not state_attr('media_player.spotify_home', 'media_album_name') ==  None }}"
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'off'
  action:
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: "1,1,{{ state_attr('media_player.spotify_home', 'media_playlist') }}"
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: "1,2,{{ state_attr('media_player.spotify_home', 'media_album_name') }}"
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: "1,3,{{ state_attr('media_player.spotify_home', 'media_artist') }}"
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: "1,4,{{ state_attr('media_player.spotify_home', 'media_title') }}"

- alias: Spotify Pause from Keypad
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'PLAY'
  condition:
    - condition: state
      entity_id: media_player.spotify_home
      state: playing
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'off'
  action:
    - service: script.spotify_pause

- alias: Spotify Play from Keypad
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'PLAY'
  condition:
    - condition: or
      conditions:
      - condition: state
        entity_id: media_player.spotify_home
        state: paused
      - condition: state
        entity_id: media_player.spotify_home
        state: 'idle'
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'off'
  action:
    - service: script.spotify_play

- alias: Spotify Next Track from Keypad
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'NEXT'
  condition:
    - condition: state
      entity_id: media_player.spotify_home
      state: playing
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'off'
  action:
    - service: script.spotify_next

- alias: Spotify Previous Track from Keypad
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'PREV'
  condition:
    - condition: state
      entity_id: media_player.spotify_home
      state: playing
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'off'
  action:
    - service: script.spotify_previous

#Menu Navigation

- alias: Spotify Nuvo Play Selection
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'PLAY'
  condition:
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'on'
  action:
    - service: script.spotify_change_playlist
    - service: input_boolean.turn_off
      entity_id: input_boolean.nuvo_spotify_in_menu

- alias: Spotify Nuvo Enter Menu
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'HPLAY'
  condition:
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'off'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.nuvo_spotify_in_menu
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,1,Select a Playliast'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,2,""'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,3,{{ states("input_select.spotify_playlist") }}'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,4,""'

- alias: Spotify Nuvo Next Playlist
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'NEXT'
  condition:
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'on'
  action:
    - service: input_select.select_next
      entity_id: input_select.spotify_playlist
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,1,Select a Playlist'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,2,""'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,3,{{ states("input_select.spotify_playlist") }}'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,4,""'

- alias: Spotify Nuvo Previous Playlist
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'PREV'
  condition:
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'on'
  action:
    - service: input_select.select_previous
      entity_id: input_select.spotify_playlist
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,1,Select a Playlist'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,2,""'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,3,{{ states("input_select.spotify_playlist") }}'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,4,""'

- alias: Spotify Nuvo Return Without Change
  trigger:
    - platform: mqtt
      topic: nuvo/tele/source/1/press
      payload: 'HPLAY'
  condition:
    - condition: state
      entity_id: input_boolean.nuvo_spotify_in_menu
      state: 'on'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.nuvo_spotify_in_menu
    - service: input_select.select_option
      data_template:
        entity_id: input_select.spotify_source
        option: "{{ state_attr('media_player.spotify_home','media_playlist') }}"    
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,1,{{ states("input_select.media_playlist") }}'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,2,{{ state_attr("media_player.spotify_home", "media_album_name") }}'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,3,{{ state_attr("media_player.spotify_home", "media_artist") }}'
    - service: mqtt.publish
      data:
        topic: nuvo/command/set/source/line
        payload_template: '1,4,{{ state_attr("media_player.spotify_home", "media_title") }}'

#Auto Zone Playback Control
- alias: Spotify Play When Source Selected
  trigger:
    - platform: mqtt
      topic: nuvo/tele/zone/#
  condition:
    - condition: template
      value_template: "{{not is_state('media_player.spotify_home', 'playing') }}"
    - condition: template
      value_template: "{{not trigger.payload_json['power'] == 'OFF'}}"
    - condition: or
      conditions:
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_1_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_1_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_2_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_2_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_3_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_3_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_4_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_4_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_5_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_5_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_6_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_6_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_7_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_7_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_8_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_8_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_9_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_9_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_10_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_10_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_11_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_11_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_12_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_12_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_13_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_13_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_14_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_14_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_15_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_15_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_16_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_16_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_17_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_17_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_18_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_18_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_19_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_19_source
              state: '1'
        - condition: and
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_20_power
              state: 'on'
            - condition: state
              entity_id: sensor.nuvo_zone_20_source
              state: '1'
  action:
    - service: script.spotify_play

- alias: Spotify Pause When Source Not In Use
  trigger:
    - platform: mqtt
      topic: nuvo/tele/zone/#
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: media_player.spotify_home
          state: playing
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_1_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_1_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_2_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_2_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_3_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_3_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_4_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_4_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_5_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_5_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_6_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_6_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_7_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_7_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_8_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_8_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_9_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_9_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_10_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_10_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_11_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_11_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_12_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_12_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_13_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_13_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_14_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_14_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_15_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_15_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_16_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_16_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_17_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_17_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_18_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_18_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_19_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_19_source') | int == 1 }}"
        - condition: or
          conditions:
            - condition: state
              entity_id: switch.nuvo_zone_20_power
              state: 'off'
            - condition: template
              value_template: "{{ not states('sensor.nuvo_zone_20_source') | int == 1 }}"     
  action:
    - service: script.spotify_pause

- alias: Spotify Pause if Alloff
  trigger:
    - platform: mqtt
      topic: nuvo/tele/system/alloff
  condition:
    - condition: state
      entity_id: media_player.spotify_home
      state: playing
  action:
    - service: script.spotify_pause

- alias: Spotify Set Refresh Timer
  trigger:
    - platform: state
      entity_id: media_player.spotify_home
  condition:
    - condition: state
      entity_id: media_player.spotify_home
      state: playing
  action:
    - service: timer.start
      data_template:
        entity_id: timer.spotify_refresh
        duration: >-
          {{ (state_attr('media_player.spotify_home','media_duration') | float - state_attr('media_player.spotify_home','media_position') | float) | round (0) }}

- alias: Spotify Refresh Info
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.spotify_refresh      
  condition:
    - condition: state
      entity_id: media_player.spotify_home
      state: playing
  action:
    - delay:
        milliseconds: 200
    - service: homeassistant.update_entity
      entity_id: media_player.spotify_home
    - delay:
        seconds: 1
    - service: homeassistant.update_entity
      entity_id: media_player.spotify_home