sensor:
    # Weather prediction
  - platform: yr

  - platform: dewpoint
    sensors:
      dewpoint_outside:
        temperature: sensor.acurite_ws_temperature
        rel_hum: sensor.acurite_ws_humidity
        
  - platform: template
    sensors:
      pws_url:
        value_template: !secret pws_url

      press_in:
        unit_of_measurement: in
        value_template: "{{ (states('sensor.aquara_den_pressure') | float * 0.02953) | round(2) }}"

      sunlight_pct:
        entity_id:
          - sun.sun
          - sensor.dark_sky_cloud_coverage
        value_template: >-
          {%- set elevation = state_attr('sun.sun','elevation') | float %}
          {%- set cloud_coverage = states('sensor.dark_sky_cloud_coverage') | float %}
          {%- set cloud_factor = (1 - (0.75 * ( cloud_coverage / 100) ** 3 )) %}
          {%- set min_elevation = -6 %}
          {%- set max_elevation = 90 %}
          {%- set adjusted_elevation = elevation - min_elevation %}
          {%- set adjusted_elevation = [adjusted_elevation,0] | max %}
          {%- set adjusted_elevation = [adjusted_elevation,max_elevation - min_elevation] | min %}
          {%- set adjusted_elevation = adjusted_elevation / (max_elevation - min_elevation) %}
          {%- set adjusted_elevation = adjusted_elevation %}
          {%- set adjusted_elevation = adjusted_elevation * 100 %}
          {%- set brightness = adjusted_elevation * cloud_factor %}
          {{ brightness | round }}
        unit_of_measurement: '%'
        device_class: 'illuminance'

# Darksky
  - platform: darksky
    api_key: !secret ds_key
    forecast:
      - 0
      - 1
      - 2
      - 3
      - 4
      - 5
    monitored_conditions:
      - icon
      - summary
      - nearest_storm_distance
      - nearest_storm_bearing
      - humidity
      - temperature
      - temperature_high
      - temperature_low
      - apparent_temperature
      - apparent_temperature_high
      - apparent_temperature_low
      - wind_speed
      - wind_bearing
      - precip_type
      - precip_probability
      - precip_accumulation
      - precip_intensity
      - precip_intensity_max
      - uv_index
      - daily_summary
      - pressure
      - visibility        

  - platform: mqtt
    name: Bear Creek Elevation
    state_topic: "hcfws/elevation"
    unit_of_measurement: "ft"
  - platform: mqtt
    name: Bear Creek Rain This Hour
    state_topic: "hcfws/rain/current"
    unit_of_measurement: "in"
  - platform: mqtt
    name: Bear Creek Rain Last Hour
    state_topic: "hcfws/rain/last"
    unit_of_measurement: "in"

rest_command:
  update_wunderground:
    url: "{{ states('sensor.pws_url') }}tempf={{ states('sensor.acurite_ws_temperature') }}&humidity={{ states('sensor.acurite_ws_humidity') }}&dewptf={{ states('sensor.dewpoint_outside') }}&baromin={{ states('sensor.press_in') }}&rainin={{ states('sensor.rain_rate') }}&dailyrainin={{ states('sensor.rain_day') }}&winddir={{ states('sensor.acurite_ws_wind_direction') }}&windspeedmph={{ states('sensor.acurite_ws_wind_speed') }}&action=updateraw"

input_boolean:
  is_raining:
    name: Currently Raining